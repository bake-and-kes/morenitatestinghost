<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci√≥n de Pedidos</title>
    <link rel="stylesheet" href="css/admin.css">
    <link rel="icon" type="image/png" href="https://i.imgur.com/cEeTbd6.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        /* ===== RESET Y ESTILOS BASE ===== */
        body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    background-color: #f8fafc;
    color: #333;
    line-height: 1.6;
}

/* ===== LAYOUT PRINCIPAL ===== */
.layout {
    display: flex;
    min-height: 100vh;
}

/* ===== SIDEBAR ===== */
.sidebar {
    width: 280px;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    overflow-y: auto;
    z-index: 1000;
}

.sidebar div:first-child {
    padding: 25px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar img {
    max-width: 180px;
    height: auto;
    display: block;
    margin: 0 auto;
    filter: brightness(0) invert(1);
}

.sidebar-header {
    text-align: center;
    padding: 20px 0;
    background-color: rgba(255, 255, 255, 0.05);
}

.sidebar-header h2 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
    letter-spacing: 0.5px;
}

.sidebar-menu {
    list-style-type: none;
    padding: 0;
    margin: 0;
    max-height: calc(100vh - 220px);
    overflow-y: auto;
    padding-bottom: 20px;
}

.sidebar-menu::-webkit-scrollbar {
    width: 6px;
}

.sidebar-menu::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
}

.sidebar-menu::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

.sidebar-menu li {
    padding: 14px 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
    color: #e2e8f0;
    font-size: 0.95rem;
}

.sidebar-menu li:hover {
    background-color: rgba(255, 255, 255, 0.05);
    border-left-color: #60a5fa;
    color: #fff;
}

.sidebar-menu li.active {
    background-color: rgba(255, 255, 255, 0.1);
    border-left-color: #60a5fa;
    color: #fff;
    font-weight: 500;
}

.sidebar-menu li a {
    text-decoration: none;
    color: inherit;
    display: block;
    transition: color 0.3s ease;
}

.dash {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
    padding: 14px 25px;
    display: block;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 10px;
    background-color: rgba(255, 255, 255, 0.05);
}

.dash a {
    color: inherit;
    text-decoration: none;
}

/* ===== CONTENIDO PRINCIPAL ===== */
.main-content {
    margin-left: 280px;
    flex-grow: 1;
    width: calc(100% - 280px);
    padding: 30px;
    min-height: 100vh;
    background-color: #f8fafc;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
}

.grafica-container {
            margin: 10px 0;
            display: flex;
            justify-content: flex-end;
        }
        
        .btn-grafica {
            background-color: #4a5568;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 13px;
        }
        
        .btn-grafica:hover {
            background-color: #2d3748;
        }
        
        .grafica-ventas {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 130%;
            max-width: 1200px;
            height: 100%;
            max-height: 670px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .grafica-header {
            padding: 15px 20px;
            background-color: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .grafica-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #2d3748;
        }
        
        .btn-cerrar {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #000000;
        }
        
        .grafica-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .grafica-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #718096;
            position: relative;
        }
        
        .tab-btn.active {
            color: #4299e1;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #4299e1;
        }
        
        .grafica-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .grafica-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .stat-box {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background-color: #f7fafc;
            width: 30%;
        }
        
        .stat-title {
            display: block;
            font-size: 14px;
            color: #718096;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #2d3748;
        }
        .dash{
            text-decoration: none;
            color: white;
            padding-inline: 0 57px;
        }
        .sidebar-header {
    text-align: center;
}
.dash{
   font-size: 20px;
}

.dash a{
    text-decoration: none;
}

/* Layout Container */
.layout {
    display: flex;
    min-height: 100vh;
}


/* ===== ESTILOS PARA TABLA DE PEDIDOS ===== */
.category-title {
    color: #1f2937;
    text-align: center;
    margin-bottom: -55px;
    font-size: 1rem;
    font-weight: 600;
    position: relative;
    padding-bottom: 10px;
    width: 500px;
    margin-top: -20px;
}

.category-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 3px;
    background: linear-gradient(to right, #4f46e5, #7c3aed);
    border-radius: 3px;
}

.pedidos-container {
    width: 100%;
    overflow-y: auto;
    max-height: calc(100vh - 250px);
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    margin-bottom: 30px;
    border: 1px solid #e5e7eb;
}

.pedidos-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.pedidos-table th {
    position: sticky;
    top: 0;
    z-index: 10;
}

.pedidos-table th, 
.pedidos-table td {
    padding: 14px 16px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
}

.pedidos-table th {
    background-color: #4f46e5;
    color: white;
    font-weight: 500;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
}

.pedidos-table tr:nth-child(even) {
    background-color: #f9fafb;
}

.pedidos-table tr:hover {
    background-color: #f3f4f6;
}

.pedidos-table tr:last-child td {
    border-bottom: none;
}

/* ===== BADGES DE ESTADO ===== */
.badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    min-width: 85px;
    letter-spacing: 0.3px;
}

.badge-pendiente {
    background-color: #fef3c7;
    color: #92400e;
}

.badge-enviado {
    background-color: #dbeafe;
    color: #1e40af;
}

.badge-entregado {
    background-color: #d1fae5;
    color: #065f46;
}

.badge-cancelado {
    background-color: #fee2e2;
    color: #991b1b;
}

/* ===== BOTONES ===== */
.btn {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s ease;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.btn-ver {
    background-color: #4f46e5;
    color: white;
}

.btn-ver:hover {
    background-color: #4338ca;
}

/* ===== DETALLE DE PEDIDO ===== */
.pedido-detalle {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60%;
    background-color: #fff;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5);
    font-size: 0.9rem;
    border-left: 5px solid #4f46e5;
    z-index: 1000;
    overflow-y: auto;
    max-height: auto;
}

.pedido-detalle h3 {
    color: #4f46e5;
    font-size: 1.1rem;
    margin-top: 15px;
    margin-bottom: 10px;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 8px;
    font-weight: 600;
}

.pedido-detalle p {
    color: #4b5563;
    font-size: 0.9rem;
    margin: 8px 0;
    line-height: 1.6;
}

.detalle-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.detalle-seccion {
    background-color: #f9fafb;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.detalle-seccion-titulo {
    font-weight: 600;
    color: #4f46e5;
    margin-bottom: 10px;
    font-size: 0.95rem;
}

.detalle-item {
    display: flex;
    margin-bottom: 8px;
}

.detalle-label {
    font-weight: 500;
    width: 130px;
    color: #6b7280;
    font-size: 0.85rem;
}

.detalle-valor {
    flex: 1;
    color: #1f2937;
    font-weight: 500;
}

.detalle-productos {
    margin-top: 20px;
    background-color: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.detalle-productos-titulo {
    background-color: #f3f4f6;
    padding: 12px 15px;
    color: #4f46e5;
    font-weight: 600;
    font-size: 0.95rem;
}

.detalle-producto-item {
    display: flex;
    padding: 12px 15px;
    border-bottom: 1px solid #e5e7eb;
    align-items: center;
}

.detalle-producto-item:last-child {
    border-bottom: none;
}

.detalle-producto-imagen {
    width: 60px;
    height: 60px;
    border-radius: 6px;
    margin-right: 15px;
    background-color: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.detalle-producto-imagen img {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover;
}

.detalle-producto-info {
    flex: 1;
}

.detalle-producto-nombre {
    font-weight: 600;
    margin-bottom: 5px;
    color: #1f2937;
    cursor: pointer;
    transition: color 0.2s;
}

.detalle-producto-nombre:hover {
    color: #4f46e5;
    text-decoration: underline;
}

.detalle-producto-datos {
    display: flex;
    font-size: 0.8rem;
    color: #6b7280;
    gap: 15px;
}

.detalle-acciones {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
    gap: 12px;
}

.btn-cerrar-detalle {
    background-color: #f3f4f6;
    color: #111214;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    border: none;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-cerrar-detalle:hover {
    background-color: #6c7077;
}

.loading {
    text-align: center;
    padding: 40px;
    font-size: 1.1rem;
    color: #6b7280;
    font-weight: 500;
}

/* ===== FILTROS ===== */
.filtros-container {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 15px;
    border: 1px solid #e5e7eb;
}

.filtro-grupo {
    display: flex;
    align-items: center;
    flex-wrap: nowrap;
    flex: 1 1 auto;
    min-width: 250px;
    max-width: 100%;
}

.filtro-label {
    font-weight: 500;
    font-size: 0.85rem;
    color: #6b7280;
    margin-right: 10px;
    white-space: nowrap;
}

.filtro-input, 
.filtro-select {
    height: 36px;
    padding: 0 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 0.85rem;
    background-color: #fff;
    flex: 1;
    min-width: 100px;
    transition: all 0.2s;
}

.filtro-select {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 14px;
    padding-right: 35px;
}

.filtro-input:focus, 
.filtro-select:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    outline: none;
}

.btn-action {
    height: 36px;
    padding: 0 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.85rem;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.btn-buscar {
    background-color: #4f46e5;
    color: white;
}

.btn-buscar:hover {
    background-color: #4338ca;
}

.actions-container {
    display: flex;
    gap: 10px;
    margin-left: auto;
}

.btn-reset, 
.btn-fix {
    padding: 0 16px;
}

.btn-reset {
    background-color: #f3f4f6;
    color: #6b7280;
}

.btn-reset:hover {
    background-color: #e5e7eb;
}

.btn-fix {
    background-color: #fee2e2;
    color: #b91c1c;
}

.btn-fix:hover {
    background-color: #fecaca;
}

/* Estilos para las opciones del select */
.option-pendiente {
    background-color: #fef3c7;
    color: #92400e;
    font-weight: 500;
}

.option-enviado {
    background-color: #dbeafe;
    color: #1e40af;
    font-weight: 500;
}

.option-entregado {
    background-color: #d1fae5;
    color: #065f46;
    font-weight: 500;
}

.option-cancelado {
    background-color: #fee2e2;
    color: #b91c1b;
    font-weight: 500;
}

/* ===== MODAL DE IMAGEN ===== */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    transition: all 0.3s ease;
}

.modal-content {
    position: relative;
    background-color: white;
    margin: 5% auto;
    padding: 25px;
    border-radius: 10px;
    width: 85%;
    max-width: 700px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    text-align: center;
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #6b7280;
    transition: color 0.2s;
}

.close-modal:hover {
    color: #1f2937;
}

.modal-image {
    max-width: 100%;
    max-height: 65vh;
    margin: 15px 0;
    border-radius: 6px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.modal-title {
    color: #4f46e5;
    margin-top: 0;
    font-size: 1.3rem;
    font-weight: 600;
}

/* ===== MENSAJE PARA M√ìVIL ===== */
.mobile-message {
    display: none;
    padding: 20px;
    text-align: center;
    background-color: #fef2f2;
    color: #b91c1c;
    border-radius: 8px;
    margin: 20px;
    border: 1px solid #fecaca;
}

.mobile-message p {
    margin-bottom: 15px;
    font-size: 1rem;
}

.btn-inicio {
    display: inline-block;
    padding: 10px 20px;
    background-color: #4f46e5;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-inicio:hover {
    background-color: #4338ca;
}



@media (max-width: 768px) {
    .sidebar {
        width: 100%;
        height: auto;
        position: static;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }
    
    .sidebar.active {
        transform: translateX(0);
    }
    
    .main-content {
        margin-left: 0;
        width: 100%;
        padding: 20px 15px;
    }
    
    .sidebar-menu li {
        text-align: left;
    }
    
    .mobile-message {
        display: block;
    }
    
    .filtros-container {
        flex-direction: column;
        gap: 10px;
    }
    
    .filtro-grupo {
        width: 100%;
        min-width: 100%;
    }
    
    .actions-container {
        margin-left: 0;
        width: 100%;
        justify-content: flex-end;
    }
    
    .pedido-detalle {
        width: 95%;
        padding: 15px;
    }
    
    .detalle-grid {
        grid-template-columns: 1fr;
    }
}


    </style>
</head>
<body>
    <div class="layout">
        <!-- Men√∫ lateral -->
        <div class="sidebar">
            <div style="display: flex; justify-content: center; align-items: center;">
                <img src="https://i.imgur.com/cEeTbd6.png" alt="" style="width: 100px; height: auto;">
            </div>
            
            <div class="sidebar-header">
                <h2 id="admin-name">Cargando...</h2> 
            </div>
            
           <ul class="sidebar-menu" id="sidebar-menu">
    <li class="dash"><a href="admin1.html">dashboard de control</a></li>
    <li data-category="todos" class="active">Inicio</li>
    <li data-category="desayunos">Desayunos</li>
    <li data-category="arreglos">Arreglos</li>
    <li data-category="fresas">Fresas</li>
    <li data-category="frutales">Frutales</li>
    <li data-category="box">Box</li>
    <li data-category="diaespecial">D√≠a Especial</li>
    <li data-category="entrega-hoy">Pedidos para hoy</li>
    <li data-category="entrega-manana">Pedidos para ma√±ana</li>
    <li class=""><a href="index.html">Modo usuario</a></li>
</ul>
        </div>
        
        <!-- Contenido principal -->
        <div class="main-content">
            <h1 id="category-title" class="category-title">Todos los pedidos</h1>
            <div class="grafica-container">
                <button id="btn-mostrar-grafica" class="btn-action btn-grafica">Ver gr√°fica de ventas</button>
            </div>
            
            <!-- Contenedor para la gr√°fica -->
            <div id="grafica-ventas" class="grafica-ventas" style="display: none;">
                <div class="grafica-header">
                    <h2 id="grafica-titulo">Ventas por Categor√≠a</h2>
                    <button id="btn-cerrar-grafica" class="btn-cerrar">√ó</button>
                </div>
                <div class="grafica-body">
                    <div class="grafica-tabs">
                        <button class="tab-btn active" data-tab="productos">Productos vendidos</button>
                        <button class="tab-btn" data-tab="ingresos">Ingresos ($)</button>
                    </div>
                    <div class="grafica-content">
                        <canvas id="grafica-canvas" width="800" height="400"></canvas>
                    </div>
                    <div class="grafica-stats">
                        <div class="stat-box">
                            <span class="stat-title">Total de pedidos</span>
                            <span id="total-pedidos" class="stat-value">0</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-title">Total de productos</span>
                            <span id="total-productos" class="stat-value">0</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-title">Ingreso total</span>
                            <span id="total-ingresos" class="stat-value">$0</span>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="container">
                <div class="filtros-container">
                    <div class="filtro-grupo">
                        <span class="filtro-label">Filtrar por estado:</span>
                        <select id="filtro-estado" class="filtro-select">
                            <option value="">Todos</option>
                            <option value="Pendiente" class="option-pendiente">Pendiente</option>
                            <option value="Enviado" class="option-enviado">Enviado</option>
                            <option value="Entregado" class="option-entregado">Entregado</option>
                            <option value="Cancelado" class="option-cancelado">Cancelado</option>
                        </select>
                        <button id="btn-buscar-estado" class="btn-action btn-buscar">Buscar</button>
                    </div>
                    
                    <div class="filtro-grupo">
                        <span class="filtro-label">Filtrar por c√≥digo:</span>
                        <input type="text" id="filtro-codigo" class="filtro-input" placeholder="C√≥digo del pedido">
                        <button id="btn-buscar-codigo" class="btn-action btn-buscar">Buscar</button>
                    </div>
                    
                    <div class="filtro-grupo">
                        <span class="filtro-label">Filtrar por fecha:</span>
                        <input type="text" id="filtro-fecha" class="filtro-input" placeholder="d/M/yyyy (ej. 4/3/2025)">
                        <button id="btn-buscar-fecha" class="btn-action btn-buscar">Buscar</button>
                    </div>
                    
                    <div class="filtro-grupo">
                        <span class="filtro-label">Filtrar por cliente:</span>
                        <input type="text" id="filtro-cliente" class="filtro-input" placeholder="Nombre del cliente">
                        <button id="btn-buscar-cliente" class="btn-action btn-buscar">Buscar</button>
                    </div>
                    
                    <div class="actions-container">
                        <button id="btn-reiniciar" class="btn-action btn-reset" style="font-size: 11px;">Reiniciar filtros</button>
                        <button id="btn-solucionar" class="btn-action btn-fix" onclick="window.location.reload();" style="font-size: 10px;">errores</button>
                    </div>
                </div>
                
                <div id="loading" class="loading">Cargando pedidos...</div>
                
                <!-- Detalle del pedido -->
                <div id="pedido-detalle" class="pedido-detalle">
                    <!-- Aqu√≠ se mostrar√° el detalle del pedido seleccionado -->
                </div>
                
                <!-- Contenedor de la tabla con scroll -->
                <div class="pedidos-container">
                    <table class="pedidos-table" id="pedidos-table">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="pedidos-body">
                            <!-- Aqu√≠ se cargar√°n los pedidos desde Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    

    <div class="mobile-message">
        <p>Este panel est√° dise√±ado para verse mejor en pantallas m√°s grandes. Por favor, accede desde un dispositivo de escritorio o tablet para una experiencia √≥ptima.</p>
        <a href="index.html" class="btn-inicio">Ir al Inicio</a>
    </div>
    <!-- Modal para vista previa de im√°genes -->
<!-- Modal para mostrar im√°genes (agr√©galo si no lo tienes) -->
<div id="overlay" class="overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;"></div>
<div id="imagen-modal" class="modal">
    <div class="modal-content">
        <span id="close-modal" class="close" style="position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer;">&times;</span>
        <h3 id="modal-title"></h3>
        <img id="modal-image" src="" alt="Imagen del producto" style="max-width: 100%; max-height: 60vh; display: block; margin: 0 auto;">
    </div>
</div>
    <div id="overlay"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Configuraci√≥n de Firebase
       const firebaseConfig = {
  apiKey: "AIzaSyBoRNOrpueYTJVeqxZwMtUsyAYArEHvgVU",
  authDomain: "morenita0ficial.firebaseapp.com",
  databaseURL: "https://morenita0ficial-default-rtdb.firebaseio.com",
  projectId: "morenita0ficial",
  storageBucket: "morenita0ficial.firebasestorage.app",
  messagingSenderId: "867231481408",
  appId: "1:867231481408:web:50512d7709d3b9d4e7a9a5"
};

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Referencia a la base de datos
        const db = firebase.database();
        const pedidosRef = db.ref('pedidos');
        const productosRef = db.ref('productos');

        // Referencias a elementos del DOM
        const pedidosBody = document.getElementById('pedidos-body');
        const loadingElement = document.getElementById('loading');
        const pedidoDetalle = document.getElementById('pedido-detalle');
        const categoryTitle = document.getElementById('category-title');
        const sidebarMenu = document.getElementById('sidebar-menu');

        const modal = document.getElementById('imagen-modal');
        const modalImage = document.getElementById('modal-image');
        const modalTitle = document.getElementById('modal-title');
        const closeModal = document.getElementById('close-modal');

        // Referencias a los filtros y botones
        const filtroEstado = document.getElementById('filtro-estado');
        const filtroCodigo = document.getElementById('filtro-codigo');
        const filtroFecha = document.getElementById('filtro-fecha');
        const filtroCliente = document.getElementById('filtro-cliente');

        const btnBuscarEstado = document.getElementById('btn-buscar-estado');
        const btnBuscarCodigo = document.getElementById('btn-buscar-codigo');
        const btnBuscarFecha = document.getElementById('btn-buscar-fecha');
        const btnBuscarCliente = document.getElementById('btn-buscar-cliente');

        // Variable para la categor√≠a actual
        let categoriaActual = 'todos';

        // Funci√≥n para cambiar la categor√≠a activa
        function cambiarCategoria(nuevaCategoria) {
    categoriaActual = nuevaCategoria;
    
    // Actualizar clases de men√∫
    const menuItems = sidebarMenu.querySelectorAll('li');
    menuItems.forEach(item => {
        if (item.getAttribute('data-category') === nuevaCategoria) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
    
    // Actualizar t√≠tulo
    if (nuevaCategoria === 'todos') {
        categoryTitle.textContent = 'Todos los pedidos';
    } else if (nuevaCategoria === 'entrega-hoy') {
        categoryTitle.textContent = 'Pedidos para entregar hoy';
    } else if (nuevaCategoria === 'entrega-manana') {
        categoryTitle.textContent = 'Pedidos para entregar ma√±ana';
    } else {
        categoryTitle.textContent = `Categor√≠a: ${nuevaCategoria.charAt(0).toUpperCase() + nuevaCategoria.slice(1)}`;
    }
    
    // Cargar pedidos de la categor√≠a
    limpiarFiltros();
    cargarPedidos();
}

        // Eventos para los elementos del men√∫
        sidebarMenu.querySelectorAll('li').forEach(item => {
            item.addEventListener('click', () => {
                const categoria = item.getAttribute('data-category');
                cambiarCategoria(categoria);
            });
        });

        // Funci√≥n para aplicar todos los filtros
        function aplicarFiltros() {
            const estado = filtroEstado.value;
            const codigo = filtroCodigo.value;
            const fecha = filtroFecha.value;
            const cliente = filtroCliente.value;

            cargarPedidos(estado, codigo, fecha, cliente);
        }

        // Eventos para los botones de b√∫squeda
        btnBuscarEstado.addEventListener('click', aplicarFiltros);
        btnBuscarCodigo.addEventListener('click', aplicarFiltros);
        btnBuscarFecha.addEventListener('click', aplicarFiltros);
        btnBuscarCliente.addEventListener('click', aplicarFiltros);

        // Funci√≥n para limpiar los filtros
        function limpiarFiltros() {
            filtroEstado.value = '';
            filtroCodigo.value = '';
            filtroFecha.value = '';
            filtroCliente.value = '';
        }

        // Evento para el bot√≥n "Reiniciar filtros"
        document.getElementById('btn-reiniciar').addEventListener('click', () => {
            limpiarFiltros();
            cargarPedidos();
        });



        function obtenerFechaHoy() {
    const hoy = new Date();
    const dia = hoy.getDate();
    const mes = hoy.getMonth() + 1;
    const anio = hoy.getFullYear();
    return `${dia}/${mes}/${anio}`;
}

function obtenerFechaManana() {
    const manana = new Date();
    manana.setDate(manana.getDate() + 1);
    const dia = manana.getDate();
    const mes = manana.getMonth() + 1;
    const anio = manana.getFullYear();
    return `${dia}/${mes}/${anio}`;
}
        // Funci√≥n para cargar los pedidos con filtros y categor√≠a
function cargarPedidos(filtroEstado = '', filtroCodigo = '', filtroFecha = '', filtroCliente = '') {
    pedidosBody.innerHTML = '';
    loadingElement.style.display = 'block';
    pedidoDetalle.style.display = 'none';

    // Detach any previous listeners to avoid duplicates
    pedidosRef.off();

    // Set up a real-time listener
    pedidosRef.orderByChild('fechaFormateada').on('value', (snapshot) => {
        loadingElement.style.display = 'none';
        pedidosBody.innerHTML = '';

        if (!snapshot.exists()) {
            pedidosBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay pedidos para mostrar</td></tr>';
            return;
        }

        // Convertir los datos a un array para ordenarlos y filtrarlos
        const pedidos = [];
        snapshot.forEach((childSnapshot) => {
            const pedido = childSnapshot.val();
            pedido.key = childSnapshot.key;

            // Aplicar filtro de categor√≠a (NUEVA L√ìGICA)
            let cumpleFiltroCategoria = true;

            if (categoriaActual === 'todos') {
                cumpleFiltroCategoria = true;
            } else if (categoriaActual === 'entrega-hoy') {
                // Filtrar por fecha de entrega de hoy
                const fechaHoy = obtenerFechaHoy();
                if (pedido.fechaEntrega) {
                    const fechaEntregaPedido = new Date(pedido.fechaEntrega);
                    const fechaEntregaFormateada = `${fechaEntregaPedido.getDate()}/${fechaEntregaPedido.getMonth() + 1}/${fechaEntregaPedido.getFullYear()}`;
                    cumpleFiltroCategoria = fechaEntregaFormateada === fechaHoy;
                } else {
                    cumpleFiltroCategoria = false;
                }
            } else if (categoriaActual === 'entrega-manana') {
                // Filtrar por fecha de entrega de ma√±ana
                const fechaManana = obtenerFechaManana();
                if (pedido.fechaEntrega) {
                    const fechaEntregaPedido = new Date(pedido.fechaEntrega);
                    const fechaEntregaFormateada = `${fechaEntregaPedido.getDate()}/${fechaEntregaPedido.getMonth() + 1}/${fechaEntregaPedido.getFullYear()}`;
                    cumpleFiltroCategoria = fechaEntregaFormateada === fechaManana;
                } else {
                    cumpleFiltroCategoria = false;
                }
            } else {
                // Filtro normal por categor√≠a
                cumpleFiltroCategoria = pedido.categoria && pedido.categoria.toLowerCase() === categoriaActual.toLowerCase();
            }
            
            // Aplicar otros filtros
            const cumpleFiltroEstado = !filtroEstado || pedido.estado === filtroEstado;
            const cumpleFiltroCodigo = !filtroCodigo || (pedido.id && pedido.id.includes(filtroCodigo));
            const cumpleFiltroCliente = !filtroCliente || (pedido.cliente && pedido.cliente.nombre && 
                                   pedido.cliente.nombre.toLowerCase().includes(filtroCliente.toLowerCase()));

            // Mejorar la l√≥gica de comparaci√≥n de fechas para el formato d/m/yyyy
            let cumpleFiltroFecha = true;
            if (filtroFecha) {
                // Normalizar el formato del filtro de fecha (d/m/yyyy)
                const partesFiltro = filtroFecha.split('/');
                
                // Asegurarse de que el filtro tenga el formato correcto
                if (partesFiltro.length === 3) {
                    const diaFiltro = parseInt(partesFiltro[0], 10);
                    const mesFiltro = parseInt(partesFiltro[1], 10);
                    const anioFiltro = parseInt(partesFiltro[2], 10);
                    
                    // Obtener la fecha del pedido
                    let fechaPedido;
                    try {
                        if (pedido.fechaFormateada) {
                            // Si es una cadena como "3/3/2025", convi√©rtela a Date
                            if (typeof pedido.fechaFormateada === 'string') {
                                const partesFechaPedido = pedido.fechaFormateada.split('/');
                                if (partesFechaPedido.length === 3) {
                                    const diaPedido = parseInt(partesFechaPedido[0], 10);
                                    const mesPedido = parseInt(partesFechaPedido[1], 10);
                                    const anioPedido = parseInt(partesFechaPedido[2], 10);
                                    
                                    // Comparaci√≥n directa de componentes de fecha
                                    cumpleFiltroFecha = (
                                        diaPedido === diaFiltro && 
                                        mesPedido === mesFiltro && 
                                        anioPedido === anioFiltro
                                    );
                                }
                            } else {
                                fechaPedido = new Date(pedido.fechaFormateada);
                            }
                        } else if (pedido.fecha) {
                            fechaPedido = new Date(pedido.fecha);
                        } else {
                            cumpleFiltroFecha = false;
                        }
                        
                        // Si tenemos un objeto Date, verificamos si coincide con el filtro
                        if (fechaPedido && fechaPedido instanceof Date && !isNaN(fechaPedido.getTime())) {
                            const diaPedido = fechaPedido.getDate();
                            const mesPedido = fechaPedido.getMonth() + 1; // getMonth() es base 0
                            const anioPedido = fechaPedido.getFullYear();
                            
                            cumpleFiltroFecha = (
                                diaPedido === diaFiltro && 
                                mesPedido === mesFiltro && 
                                anioPedido === anioFiltro
                            );
                        }
                    } catch (error) {
                        console.error("Error al procesar fecha:", error);
                        cumpleFiltroFecha = false;
                    }
                } else {
                    // Si el formato del filtro no es correcto, no cumple el filtro
                    cumpleFiltroFecha = false;
                }
            }

            if (cumpleFiltroCategoria && cumpleFiltroEstado && cumpleFiltroCodigo && cumpleFiltroFecha && cumpleFiltroCliente) {
                pedidos.push(pedido);
            }
        });

        // Ordenar por timestamp (descendente)
        pedidos.sort((a, b) => b.timestamp - a.timestamp);

        if (pedidos.length === 0) {
            pedidosBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay pedidos para mostrar</td></tr>';
            return;
        }

        // Mostrar los pedidos
        pedidos.forEach((pedido) => {
            const row = document.createElement('tr');

            // Determinar la clase para el badge de estado
            let badgeClass = '';
            switch (pedido.estado) {
                case 'Pendiente': badgeClass = 'badge-pendiente'; break;
                case 'Enviado': badgeClass = 'badge-enviado'; break;
                case 'Entregado': badgeClass = 'badge-entregado'; break;
                case 'Cancelado': badgeClass = 'badge-cancelado'; break;
                default: badgeClass = 'badge-pendiente';
            }

            // Formatear la fecha si no est√° formateada
            const fecha = pedido.fechaFormateada || new Date(pedido.fecha).toLocaleDateString();

            // Usar siempre el c√≥digo exacto del pedido
            const codigoPedido = pedido.id || 'Sin c√≥digo';
            
            // Categor√≠a del pedido (si existe)
            const categoriaPedido = pedido.categoria || 'No especificada';

            row.innerHTML = `
                <td>${codigoPedido}</td>
                <td>${fecha}</td>
                <td>${pedido.cliente.nombre}</td>
                <td>$${pedido.total}</td>
                <td><span class="badge ${badgeClass}">${pedido.estado}</span></td>
                <td>
                    <button class="btn btn-ver" data-key="${pedido.key}">Ver detalle</button>
                </td>
            `;

            pedidosBody.appendChild(row);
        });

        // Agregar eventos para los botones de detalle
        const botonesDetalle = document.querySelectorAll('.btn-ver');
        botonesDetalle.forEach(boton => {
            boton.addEventListener('click', (e) => {
                const pedidoKey = e.target.getAttribute('data-key');
                mostrarDetallePedido(pedidoKey);
            });
        });
    }, (error) => {
        console.error("Error al obtener pedidos: ", error);
        loadingElement.style.display = 'none';
        pedidosBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Error al cargar los pedidos</td></tr>';
    });
}


     // Funci√≥n para mostrar el detalle de un pedido
function mostrarDetallePedido(pedidoKey) {
    pedidoDetalle.innerHTML = 'Cargando...';
    pedidoDetalle.style.display = 'block';
    
    pedidosRef.child(pedidoKey).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const pedido = snapshot.val();
                
                // Crear HTML para los productos
                let productosHTML = '';
                pedido.productos.forEach(producto => {
                    productosHTML += `
                        <div style="display: flex; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                            <div style="margin-right: 10px;">
                                <span class="producto-nombre" 
                                    data-id="${producto.id}" 
                                    data-imagen="${producto.imagen || ''}"
                                    style="cursor: pointer; color: #0066cc; text-decoration: underline;">${producto.nombre}</span>
                                <small style="display: block; color: #666;">(Haz clic para ver imagen)</small>
                            </div>
                            <div style="margin-left: auto;">$${producto.precio} x ${producto.cantidad} = $${producto.precio * producto.cantidad}</div>
                        </div>
                    `;
                });
                
                // Formatear la fecha si no est√° formateada
                const fecha = pedido.fechaFormateada || new Date(pedido.fecha).toLocaleDateString();
                
                // Usar el mismo c√≥digo que en la factura
                const codigoPedido = pedido.codigoFactura || pedido.id || 'Sin c√≥digo';
                
                // Mostrar la categor√≠a del pedido
                const categoriaPedido = pedido.categoria || 'No especificada';
                
                // Crear HTML para el detalle del pedido con los NUEVOS CAMPOS
                pedidoDetalle.innerHTML = `
                    <h2>Detalles del Pedido #${codigoPedido}</h2>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 300px;">
                            <h3>Informaci√≥n del Cliente</h3>
                            <p><strong>Nombre:</strong> ${pedido.cliente.nombre}</p>
                            <p><strong>Email:</strong> ${pedido.cliente.email}</p>
                            <p><strong>Tel√©fono:</strong> ${pedido.cliente.telefono || 'No especificado'}</p>
                            <p><strong>Direcci√≥n:</strong> ${pedido.cliente.direccion}</p>
                            
                            <!-- NUEVOS CAMPOS AQU√ç -->
                            ${pedido.cliente.puntoReferencia ? `<p><strong>Punto de referencia:</strong> ${pedido.cliente.puntoReferencia}</p>` : ''}
                            
                            <h3>Informaci√≥n del Receptor</h3>
                            ${pedido.receptor ? `
                                <p><strong>Qui√©n recibe:</strong> ${pedido.receptor.nombre || 'No especificado'}</p>
                                <p><strong>Celular receptor:</strong> ${pedido.receptor.celular || 'No especificado'}</p>
                            ` : '<p>No hay informaci√≥n del receptor</p>'}
                            
                            <h3>Detalles del Pedido</h3>
                            <p><strong>C√≥digo:</strong> ${codigoPedido}</p>
                            <p><strong>Fecha:</strong> ${fecha}</p>
                            ${pedido.fechaEntrega ? `<p><strong>Fecha de entrega:</strong> ${new Date(pedido.fechaEntrega).toLocaleDateString()}</p>` : ''}
                            <p><strong>Categor√≠a:</strong> ${categoriaPedido}</p>
                            <p><strong>Estado:</strong> 
                                <select id="cambiar-estado" data-key="${pedidoKey}">
                                    <option value="Pendiente" ${pedido.estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                    <option value="Enviado" ${pedido.estado === 'Enviado' ? 'selected' : ''}>Enviado</option>
                                    <option value="Entregado" ${pedido.estado === 'Entregado' ? 'selected' : ''}>Entregado</option>
                                    <option value="Cancelado" ${pedido.estado === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                                </select>
                            </p>
                            <p><strong>M√©todo de pago:</strong> ${pedido.metodo_pago}</p>
                            
                            <div style="margin-top: 20px;">
                                <label for="cambiar-categoria"><strong>Categor√≠a del pedido:</strong></label>
                                <select id="cambiar-categoria" data-key="${pedidoKey}">
                                    <option value="" ${!pedido.categoria ? 'selected' : ''}>No especificada</option>
                                    <option value="desayunos" ${pedido.categoria === 'desayunos' ? 'selected' : ''}>Desayunos</option>
                                    <option value="arreglos" ${pedido.categoria === 'arreglos' ? 'selected' : ''}>Arreglos</option>
                                    <option value="fresas" ${pedido.categoria === 'fresas' ? 'selected' : ''}>Fresas</option>
                                    <option value="frutales" ${pedido.categoria === 'frutales' ? 'selected' : ''}>Frutales</option>
                                    <option value="box" ${pedido.categoria === 'box' ? 'selected' : ''}>Box</option>
                                    <option value="diaespecial" ${pedido.categoria === 'diaespecial' ? 'selected' : ''}>D√≠a Especial</option>
                                </select>
                                <button id="guardar-categoria" data-key="${pedidoKey}" style="margin-left: 10px;" class="btn-action">Guardar categor√≠a</button>
                            </div>
                        </div>
                        
                        <div style="flex: 1; min-width: 300px;">
                            <h3>Productos</h3>
                            ${productosHTML}
                            
                            <div style="margin-top: 20px;">
                                <p><strong>Subtotal:</strong> $${pedido.subtotal}</p>
                                <p><strong>Env√≠o:</strong> $${pedido.envio}</p>
                                ${pedido.adicionales_costo > 0 ? `<p><strong>Adicionales:</strong> $${pedido.adicionales_costo}</p>` : ''}
                                <p style="font-size: 18px;"><strong>Total:</strong> $${pedido.total}</p>
                            </div>
                            
                            <h3>Opciones adicionales</h3>
                            ${
                                pedido.adicionales.mensajeGloboPersonalizado && pedido.adicionales.mensajeGloboPersonalizado.trim()
                                ? `<p><strong>Mensaje globo personalizado:</strong> ${pedido.adicionales.mensajeGloboPersonalizado} ($3000)</p>`
                                : `<p><strong>Mensaje de globo:</strong> ${
                                    pedido.adicionales.motivo && pedido.adicionales.motivo.trim()
                                    ? pedido.adicionales.motivo
                                    : 'No especificado'
                                }</p>`
                            }
                            
                            <p><strong>Globos:</strong> ${pedido.adicionales.globos}</p>
                            <p><strong>Color de globo:</strong> 
                                ${
                                    pedido.adicionales.colorGlobo
                                    ? pedido.adicionales.colorGlobo.split(',').map(url => 
                                        `<img src="${url.trim()}" alt="Color de globo"
                                            style="width: 50px; height: 50px; border-radius: 50%; margin-left: 10px; cursor: pointer;" 
                                            class="imagen-globo" data-url="${url.trim()}">`
                                    ).join('')
                                    : 'No especificado'
                                }
                            </p>
                            
                            <!-- NUEVO: Selector de color de lazo para desayunos -->
                            ${pedido.adicionales.colorLazo ? `
                                <p><strong>Color del lazo:</strong> 
                                    <div style="display: flex; align-items: center; margin-top: 5px;">
                                        <div style="width: 30px; height: 30px; border-radius: 50%; background-color: ${pedido.adicionales.colorLazo.codigo}; border: 2px solid #ccc; margin-right: 10px;"></div>
                                        <span>${pedido.adicionales.colorLazo.nombre}</span>
                                    </div>
                                </p>
                            ` : ''}
                            
                            <p><strong>Mensaje:</strong> ${pedido.adicionales.mensaje}</p>
                        </div>
                    </div>
                    
                    <button id="cerrar-detalle" style="margin-top: 20px;" class="btn-cerrar">Cerrar</button>
                `;
                
                // El resto del c√≥digo permanece igual...
                document.querySelectorAll('.imagen-globo').forEach(img => {
                    img.addEventListener('click', (e) => {
                        const url = e.currentTarget.dataset.url;
                        mostrarImagenDirecta(url, 'Color de globo seleccionado');
                    });
                });
                
                // Agregar evento para cambiar el estado
                const selectEstado = document.getElementById('cambiar-estado');
                if (selectEstado) {
                    selectEstado.addEventListener('change', (e) => {
                        const nuevoEstado = e.target.value;
                        const pedidoKey = e.target.getAttribute('data-key');
                        
                        pedidosRef.child(pedidoKey).update({
                            estado: nuevoEstado
                        })
                        .then(() => {
                            alert('Estado actualizado correctamente');
                            cargarPedidos(filtroEstado.value);
                        })
                        .catch((error) => {
                            console.error("Error al actualizar estado: ", error);
                            alert('Error al actualizar el estado');
                        });
                    });
                }
                
                // Agregar evento para guardar categor√≠a
                const btnGuardarCategoria = document.getElementById('guardar-categoria');
                if (btnGuardarCategoria) {
                    btnGuardarCategoria.addEventListener('click', (e) => {
                        const pedidoKey = e.target.getAttribute('data-key');
                        const nuevaCategoria = document.getElementById('cambiar-categoria').value;
                        
                        pedidosRef.child(pedidoKey).update({
                            categoria: nuevaCategoria
                        })
                        .then(() => {
                            alert('Categor√≠a actualizada correctamente');
                            if (categoriaActual !== 'todos' && nuevaCategoria !== categoriaActual) {
                                // Si el pedido ya no pertenece a la categor√≠a actual, recargamos
                                cargarPedidos(filtroEstado.value);
                            }
                        })
                        .catch((error) => {
                            console.error("Error al actualizar categor√≠a: ", error);
                            alert('Error al actualizar la categor√≠a');
                        });
                    });
                }
                
                // Agregar evento para cerrar detalle
                const btnCerrar = document.getElementById('cerrar-detalle');
                if (btnCerrar) {
                    btnCerrar.addEventListener('click', () => {
                        pedidoDetalle.style.display = 'none';
                    });
                }
                
                // Eventos para im√°genes (si aplica)
                const imagenGlobo = document.querySelector('.imagen-globo');
                if (imagenGlobo) {
                    imagenGlobo.addEventListener('click', (e) => {
                        const urlImagen = e.target.getAttribute('data-url');
                        mostrarImagenDirecta(urlImagen, 'Color de globo seleccionado');
                    });
                }
                
                // Agregar eventos a los nombres de productos
                const nombresProductos = document.querySelectorAll('.producto-nombre');
                nombresProductos.forEach(nombre => {
                    nombre.addEventListener('click', (e) => {
                        const imagenUrl = e.target.getAttribute('data-imagen');
                        const nombreProducto = e.target.textContent;
                        
                        if (imagenUrl) {
                            mostrarImagenDirecta(imagenUrl, nombreProducto);
                        } else {
                            alert('Este producto no tiene imagen disponible.');
                        }
                    });
                });
            } else {
                pedidoDetalle.innerHTML = '<p>No se encontr√≥ el pedido</p>';
            }
        })
        .catch((error) => {
            console.error("Error al obtener detalle del pedido: ", error);
            pedidoDetalle.innerHTML = '<p>Error al cargar el detalle del pedido</p>';
        });
}



function mostrarImagenDirecta(imagenUrl, nombreProducto) {
    if (!imagenUrl) {
        alert('Este producto no tiene imagen disponible.');
        return;
    }
    
    modalImage.src = imagenUrl;
    modalTitle.textContent = nombreProducto || 'Imagen del producto';
    
    // Mostrar el modal y el overlay
    modal.style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
    
    console.log("Mostrando imagen:", imagenUrl);
}


        // Funci√≥n para mostrar imagen de un producto
        function mostrarImagenProducto(productoId, nombreProducto) {
            if (!productoId) return;
            
            productosRef.child(productoId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const producto = snapshot.val();
                        if (producto.imagen) {
                            modalImage.src = producto.imagen;
                            modalTitle.textContent = nombreProducto || producto.nombre;
                            modal.style.display = 'block';
                            document.getElementById('overlay').style.display = 'block';
                        } else {
                            alert('Este producto no tiene imagen disponible.');
                        }
                    } else {
                        alert('No se encontr√≥ informaci√≥n de este producto.');
                    }
                })
                .catch((error) => {
                    console.error("Error al obtener imagen del producto: ", error);
                    alert('Error al cargar la imagen del producto');
                });
        }

        // Funci√≥n para mostrar imagen de globo
        function mostrarImagenGlobo(urlImagen) {
            if (!urlImagen) return;
            
            modalImage.src = urlImagen;
            modalTitle.textContent = 'Color de globo seleccionado';
            modal.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        // Evento para cerrar el modal
        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        });

        // Tambi√©n cerrar el modal si se hace clic fuera de √©l
        window.addEventListener('click', (e) => {
            if (e.target === modal || e.target === document.getElementById('overlay')) {
                modal.style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }
        });

        // Evento para reiniciar filtros
        document.getElementById('btn-reiniciar').addEventListener('click', () => {
            limpiarFiltros();
            cargarPedidos();
        });

        // Eventos para los elementos del men√∫ lateral
        sidebarMenu.querySelectorAll('li').forEach(item => {
            item.addEventListener('click', () => {
                const categoria = item.getAttribute('data-category');
                cambiarCategoria(categoria);
            });
        });

        // Inicializar la aplicaci√≥n cargando todos los pedidos
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar si hay una categor√≠a en la URL
            const params = new URLSearchParams(window.location.search);
            const categoriaParam = params.get('categoria');
            
            if (categoriaParam) {
                // Si hay una categor√≠a en la URL, seleccionarla
                cambiarCategoria(categoriaParam);
                
                // Tambi√©n seleccionar visualmente en el men√∫
                const menuItem = document.querySelector(`[data-category="${categoriaParam}"]`);
                if (menuItem) {
                    menuItem.classList.add('active');
                }
            } else {
                // Por defecto, cargar todos los pedidos
                cargarPedidos();
            }
        });
    </script>

<script>
    // Variables para la gr√°fica
    let graficaChart = null;
    let datosProductos = {};
    let datosIngresos = {};
    let tipoGraficaActual = 'productos';
    
    // DOM Elements
    const btnMostrarGrafica = document.getElementById('btn-mostrar-grafica');
    const btnCerrarGrafica = document.getElementById('btn-cerrar-grafica');
    const graficaVentas = document.getElementById('grafica-ventas');
    const graficaTitulo = document.getElementById('grafica-titulo');
    const graficaCanvas = document.getElementById('grafica-canvas');
    const totalPedidos = document.getElementById('total-pedidos');
    const totalProductos = document.getElementById('total-productos');
    const totalIngresos = document.getElementById('total-ingresos');
    
    // Evento para mostrar la gr√°fica
    btnMostrarGrafica.addEventListener('click', () => {
        // Actualizar t√≠tulo seg√∫n la categor√≠a
        let tituloCategoria = 'Todos los pedidos';
        if (categoriaActual !== 'todos') {
            tituloCategoria = categoriaActual.charAt(0).toUpperCase() + categoriaActual.slice(1);
        }
        graficaTitulo.textContent = `Ventas de ${tituloCategoria}`;
        
        // Recopilar datos y mostrar gr√°fica
        recopilarDatosVentas();
        
        // Mostrar el modal de gr√°fica
        graficaVentas.style.display = 'flex';
        document.getElementById('overlay').style.display = 'block';
    });
    
    // Cerrar la gr√°fica
    btnCerrarGrafica.addEventListener('click', () => {
        graficaVentas.style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
        
        // Destruir la gr√°fica actual para liberar memoria
        if (graficaChart) {
            graficaChart.destroy();
            graficaChart = null;
        }
    });
    
    // Cambiar entre tabs de gr√°ficas
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            // Actualizar clase activa
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            // Cambiar tipo de gr√°fica
            tipoGraficaActual = e.target.getAttribute('data-tab');
            actualizarGrafica();
        });
    });
    
    // Funci√≥n para recopilar datos de ventas
    function recopilarDatosVentas() {
        // Reiniciar datos
        datosProductos = {};
        datosIngresos = {};
        let contadorPedidos = 0;
        let contadorProductosTotal = 0;
        let ingresoTotal = 0;
        
        // Obtener todos los pedidos
        pedidosRef.once('value')
            .then((snapshot) => {
                if (!snapshot.exists()) {
                    mostrarGraficaSinDatos();
                    return;
                }
                
                snapshot.forEach((childSnapshot) => {
                    const pedido = childSnapshot.val();
                    
                    // Verificar si el pedido pertenece a la categor√≠a actual
                    const pedidoCategoria = pedido.categoria || 'sin_categoria';
                    
                    // Solo contar pedidos entregados (no cancelados)
                    if (pedido.estado !== 'Cancelado') {
                        // Si estamos filtrando por categor√≠a y no coincide, saltamos este pedido
                        if (categoriaActual !== 'todos' && pedidoCategoria !== categoriaActual) {
                            return;
                        }
                        
                        contadorPedidos++;
                        
                        // Procesar productos del pedido
                        if (pedido.productos && Array.isArray(pedido.productos)) {
                            pedido.productos.forEach(producto => {
                                const nombreProducto = producto.nombre;
                                const cantidad = producto.cantidad || 1;
                                const precio = producto.precio * cantidad;
                                
                                // Suma para estad√≠sticas generales
                                contadorProductosTotal += cantidad;
                                ingresoTotal += precio;
                                
                                // Datos para gr√°fica de productos
                                if (!datosProductos[nombreProducto]) {
                                    datosProductos[nombreProducto] = cantidad;
                                } else {
                                    datosProductos[nombreProducto] += cantidad;
                                }
                                
                                // Datos para gr√°fica de ingresos
                                if (!datosIngresos[nombreProducto]) {
                                    datosIngresos[nombreProducto] = precio;
                                } else {
                                    datosIngresos[nombreProducto] += precio;
                                }
                            });
                        }
                    }
                });
                
                // Actualizar estad√≠sticas
                totalPedidos.textContent = contadorPedidos;
                totalProductos.textContent = contadorProductosTotal;
                totalIngresos.textContent = `$${ingresoTotal.toLocaleString()}`;
                
                // Crear o actualizar la gr√°fica
                actualizarGrafica();
            })
            .catch((error) => {
                console.error("Error al recopilar datos de ventas: ", error);
                mostrarGraficaSinDatos();
            });
    }
    
    // Funci√≥n para actualizar la gr√°fica
    function actualizarGrafica() {
        // Destruir gr√°fica existente si hay
        if (graficaChart) {
            graficaChart.destroy();
        }
        
        // Obtener datos seg√∫n el tipo de gr√°fica seleccionado
        const datos = tipoGraficaActual === 'productos' ? datosProductos : datosIngresos;
        
        // Ordenar datos para mostrar los m√°s vendidos primero
        const datosOrdenados = Object.entries(datos)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10); // Mostrar solo los 10 principales
        
        const labels = datosOrdenados.map(item => item[0]);
        const values = datosOrdenados.map(item => item[1]);
        
        // Crear colores aleatorios pero consistentes
        const backgroundColors = generarColores(labels.length);
        
        // Verificar si hay datos
        if (labels.length === 0) {
            mostrarGraficaSinDatos();
            return;
        }
        
        // Crear la gr√°fica
        const ctx = graficaCanvas.getContext('2d');
        graficaChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: tipoGraficaActual === 'productos' ? 'Cantidad vendida' : 'Ingresos ($)',
                    data: values,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors.map(color => color.replace('0.6', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (tipoGraficaActual === 'ingresos') {
                                    label += '$' + context.parsed.y.toLocaleString();
                                } else {
                                    label += context.parsed.y;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (tipoGraficaActual === 'ingresos') {
                                    return '$' + value;
                                }
                                return value;
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }
    
    // Funci√≥n para mostrar gr√°fica sin datos
    function mostrarGraficaSinDatos() {
        totalPedidos.textContent = '0';
        totalProductos.textContent = '0';
        totalIngresos.textContent = '$0';
        
        // Destruir gr√°fica existente si hay
        if (graficaChart) {
            graficaChart.destroy();
        }
        
        // Crear gr√°fica vac√≠a con mensaje
        const ctx = graficaCanvas.getContext('2d');
        graficaChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Sin datos'],
                datasets: [{
                    label: 'No hay datos disponibles',
                    data: [0],
                    backgroundColor: ['rgba(200, 200, 200, 0.2)'],
                    borderColor: ['rgba(200, 200, 200, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1
                    }
                }
            }
        });
    }
    
    // Funci√≥n para generar colores
    function generarColores(cantidad) {
        const colores = [];
        for (let i = 0; i < cantidad; i++) {
            // Usar una paleta predefinida para que se vea profesional
            const paleta = [
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 99, 132, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(255, 159, 64, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 205, 86, 0.6)',
                'rgba(201, 203, 207, 0.6)',
                'rgba(255, 99, 71, 0.6)',
                'rgba(46, 139, 87, 0.6)',
                'rgba(106, 90, 205, 0.6)'
            ];
            colores.push(paleta[i % paleta.length]);
        }
        return colores;
    }
    
    // Actualizar evento para cambiar de categor√≠a para refrescar tambi√©n el t√≠tulo del bot√≥n
    function cambiarCategoria(nuevaCategoria) {
    categoriaActual = nuevaCategoria;
    
    // Actualizar clases de men√∫
    const menuItems = sidebarMenu.querySelectorAll('li');
    menuItems.forEach(item => {
        if (item.getAttribute('data-category') === nuevaCategoria) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
    
    // Actualizar t√≠tulo
    if (nuevaCategoria === 'todos') {
        categoryTitle.textContent = 'Todos los pedidos';
    } else if (nuevaCategoria === 'entrega-hoy') {
        categoryTitle.textContent = 'Pedidos para entregar hoy';
    } else if (nuevaCategoria === 'entrega-manana') {
        categoryTitle.textContent = 'Pedidos para entregar ma√±ana';
    } else {
        categoryTitle.textContent = `Categor√≠a: ${nuevaCategoria.charAt(0).toUpperCase() + nuevaCategoria.slice(1)}`;
    }
    
    // Cargar pedidos de la categor√≠a
    limpiarFiltros();
    cargarPedidos();
    
    // Si la gr√°fica est√° abierta, actualizarla
    if (typeof graficaVentas !== 'undefined' && graficaVentas && graficaVentas.style.display === 'flex') {
        recopilarDatosVentas();
    }
}
    </script>

<script>
    // Funci√≥n para mostrar gr√°fica de productos del d√≠a especial
function mostrarGraficaDiaEspecial() {
    // Crear toda la estructura necesaria desde cero
    // 1. Crear el overlay si no existe
    let overlay = document.getElementById('overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'overlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        overlay.style.zIndex = '1000';
        overlay.style.display = 'none';
        document.body.appendChild(overlay);
    }

    // 2. Crear el contenedor de la gr√°fica del d√≠a especial
    const graficaDiaEspecial = document.createElement('div');
    graficaDiaEspecial.id = 'grafica-dia-especial';
    graficaDiaEspecial.style.position = 'fixed';
    graficaDiaEspecial.style.top = '50%';
    graficaDiaEspecial.style.left = '50%';
    graficaDiaEspecial.style.transform = 'translate(-50%, -50%)';
    graficaDiaEspecial.style.backgroundColor = 'white';
    graficaDiaEspecial.style.padding = '20px';
    graficaDiaEspecial.style.borderRadius = '8px';
    graficaDiaEspecial.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
    graficaDiaEspecial.style.zIndex = '1001';
    graficaDiaEspecial.style.display = 'none';
    graficaDiaEspecial.style.width = '100%';
    graficaDiaEspecial.style.maxWidth = '1200px';
    graficaDiaEspecial.style.maxHeight = '100vh';
    graficaDiaEspecial.style.overflow = 'auto';

    // 3. Crear la estructura del modal con el campo de fecha
    graficaDiaEspecial.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 id="grafica-especial-titulo" style="margin: 0;">Ventas del D√≠a Especial</h2>
            <button id="btn-cerrar-especial" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
        </div>
        <div style="display: flex; margin-bottom: 15px;">
            <input type="text" id="fecha-filtro" placeholder="Ingrese la fecha (dd/mm/yyyy)" style="padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px;">
            <button id="btn-filtrar-fecha" style="padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Filtrar por Fecha</button>
        </div>
        <div style="display: flex; margin-bottom: 15px;">
            <button class="tab-btn-especial active" data-tab="productos" style="padding: 8px 15px; margin-right: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Productos</button>
            <button class="tab-btn-especial" data-tab="ingresos" style="padding: 8px 15px; background-color: #f1f1f1; border: none; border-radius: 4px; cursor: pointer;">Ingresos</button>
        </div>
        <div style="height: 400px; margin-bottom: 20px;">
            <canvas id="grafica-especial-canvas"></canvas>
        </div>
        <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 150px; padding: 10px; margin: 5px; background-color: #f9f9f9; border-radius: 4px; text-align: center;">
                <div style="font-weight: bold; margin-bottom: 5px;">Total Pedidos:</div>
                <div id="total-pedidos-especial" style="font-size: 18px;">0</div>
            </div>
            <div style="flex: 1; min-width: 150px; padding: 10px; margin: 5px; background-color: #f9f9f9; border-radius: 4px; text-align: center;">
                <div style="font-weight: bold; margin-bottom: 5px;">Total Productos:</div>
                <div id="total-productos-especial" style="font-size: 18px;">0</div>
            </div>
            <div style="flex: 1; min-width: 150px; padding: 10px; margin: 5px; background-color: #f9f9f9; border-radius: 4px; text-align: center;">
                <div style="font-weight: bold; margin-bottom: 5px;">Total Ingresos:</div>
                <div id="total-ingresos-especial" style="font-size: 18px;">$0</div>
            </div>
        </div>
    `;

    // 4. Agregar el modal al body
    document.body.appendChild(graficaDiaEspecial);

    // 5. Crear el bot√≥n para mostrar la gr√°fica del d√≠a especial
    const btnDiaEspecial = document.createElement('button');
    btnDiaEspecial.id = 'btn-dia-especial';
    btnDiaEspecial.textContent = 'Ver D√≠a Especial';
    btnDiaEspecial.style.padding = '5px 15px';
    btnDiaEspecial.style.backgroundColor = '#4CAF50';
    btnDiaEspecial.style.color = 'white';
    btnDiaEspecial.style.border = 'none';
    btnDiaEspecial.style.borderRadius = '4px';
    btnDiaEspecial.style.cursor = 'pointer';
    btnDiaEspecial.style.margin = '2px';
    btnDiaEspecial.style.marginTop = '12px';

    // 6. Encontrar un lugar adecuado para a√±adir el bot√≥n
    let botonInsertado = false;

    // Intento 1: Buscar un contenedor de acciones
    const accionesContainer = document.querySelector('.acciones-container');
    if (accionesContainer) {
        accionesContainer.appendChild(btnDiaEspecial);
        botonInsertado = true;
    }

    // Intento 2: Buscar el header
    if (!botonInsertado) {
        const header = document.querySelector('header');
        if (header) {
            header.appendChild(btnDiaEspecial);
            botonInsertado = true;
        }
    }

    // Intento 3: Buscar el bot√≥n de mostrar gr√°fica existente y poner el nuevo a su lado
    if (!botonInsertado) {
        const btnMostrarGrafica = document.getElementById('btn-mostrar-grafica');
        if (btnMostrarGrafica && btnMostrarGrafica.parentNode) {
            btnMostrarGrafica.parentNode.insertBefore(btnDiaEspecial, btnMostrarGrafica.nextSibling);
            botonInsertado = true;
        }
    }

    // Intento 4: Como √∫ltimo recurso, a√±adirlo al principio del body
    if (!botonInsertado) {
        const primerElemento = document.body.firstChild;
        document.body.insertBefore(btnDiaEspecial, primerElemento);
    }

    // Variables para la gr√°fica
    let graficaEspecialChart = null;
    let datosProductosEspecial = {};
    let datosIngresosEspecial = {};
    let tipoGraficaEspecialActual = 'productos';

    // Evento para mostrar la gr√°fica y cargar todos los datos
    btnDiaEspecial.addEventListener('click', () => {
        graficaDiaEspecial.style.display = 'block';
        overlay.style.display = 'block';
        // Cargar todos los datos al abrir el modal
        recopilarTodosLosDatosVentasEspeciales();
    });

    // Cerrar la gr√°fica
    document.getElementById('btn-cerrar-especial').addEventListener('click', () => {
        graficaDiaEspecial.style.display = 'none';
        overlay.style.display = 'none';

        // Destruir la gr√°fica actual para liberar memoria
        if (graficaEspecialChart) {
            graficaEspecialChart.destroy();
            graficaEspecialChart = null;
        }
    });

    // Filtrar por fecha
    document.getElementById('btn-filtrar-fecha').addEventListener('click', () => {
        const fechaFiltro = document.getElementById('fecha-filtro').value;
        if (fechaFiltro) {
            recopilarDatosVentasEspeciales(fechaFiltro);
        } else {
            alert("Por favor, ingrese una fecha en el formato dd/mm/yyyy.");
        }
    });
    

    // Cambiar entre tabs de productos e ingresos
    const tabBtns = document.querySelectorAll('.tab-btn-especial');
    tabBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            // Cambiar estilo de los botones
            tabBtns.forEach(b => {
                b.style.backgroundColor = '#f1f1f1';
                b.style.color = 'black';
                b.classList.remove('active');
            });
            e.target.style.backgroundColor = '#4CAF50';
            e.target.style.color = 'white';
            e.target.classList.add('active');

            // Actualizar tipo de gr√°fica actual
            tipoGraficaEspecialActual = e.target.dataset.tab;
            
            // Actualizar la gr√°fica con los datos actuales
            actualizarGraficaEspecial();
        });
    });

    // Funci√≥n para recopilar todos los datos sin filtro de fecha
    function recopilarTodosLosDatosVentasEspeciales() {
        // Reiniciar datos
        datosProductosEspecial = {};
        datosIngresosEspecial = {};
        let contadorPedidos = 0;
        let contadorProductosTotal = 0;
        let ingresoTotal = 0;

        // Verificar si Firebase y pedidosRef est√°n disponibles
        if (typeof firebase === 'undefined' || typeof pedidosRef === 'undefined') {
            console.error("Firebase o pedidosRef no est√°n disponibles");
            mostrarGraficaEspecialSinDatos("Firebase no inicializado");
            return;
        }

        // Obtener todos los pedidos
        pedidosRef.once('value')
            .then((snapshot) => {
                if (!snapshot.exists()) {
                    mostrarGraficaEspecialSinDatos();
                    return;
                }

                snapshot.forEach((childSnapshot) => {
                    const pedido = childSnapshot.val();

                    // Verificar si el pedido es del d√≠a especial
                    if (pedido.categoria === 'diaespecial' && pedido.estado !== 'Cancelado') {
                        contadorPedidos++;

                        // Procesar productos del pedido
                        if (pedido.productos && Array.isArray(pedido.productos)) {
                            pedido.productos.forEach(producto => {
                                const nombreProducto = producto.nombre;
                                const cantidad = producto.cantidad || 1;
                                const precio = parseFloat(producto.precio || 0) * cantidad;

                                // Suma para estad√≠sticas generales
                                contadorProductosTotal += cantidad;
                                ingresoTotal += precio;

                                // Datos para gr√°fica de productos
                                if (!datosProductosEspecial[nombreProducto]) {
                                    datosProductosEspecial[nombreProducto] = cantidad;
                                } else {
                                    datosProductosEspecial[nombreProducto] += cantidad;
                                }

                                // Datos para gr√°fica de ingresos
                                if (!datosIngresosEspecial[nombreProducto]) {
                                    datosIngresosEspecial[nombreProducto] = precio;
                                } else {
                                    datosIngresosEspecial[nombreProducto] += precio;
                                }
                            });
                        }
                    }
                });

                // Actualizar estad√≠sticas
                document.getElementById('total-pedidos-especial').textContent = contadorPedidos;
                document.getElementById('total-productos-especial').textContent = contadorProductosTotal;
                document.getElementById('total-ingresos-especial').textContent = `$${ingresoTotal.toLocaleString()}`;

                // Crear o actualizar la gr√°fica
                actualizarGraficaEspecial();
            })
            .catch((error) => {
                console.error("Error al recopilar datos de ventas del d√≠a especial: ", error);
                mostrarGraficaEspecialSinDatos("Error: " + error.message);
            });
    }

    // Funci√≥n para recopilar datos de ventas del d√≠a especial con filtro de fecha
    function recopilarDatosVentasEspeciales(fechaFormateada) {
        // Reiniciar datos
        datosProductosEspecial = {};
        datosIngresosEspecial = {};
        let contadorPedidos = 0;
        let contadorProductosTotal = 0;
        let ingresoTotal = 0;

        // Verificar si Firebase y pedidosRef est√°n disponibles
        if (typeof firebase === 'undefined' || typeof pedidosRef === 'undefined') {
            console.error("Firebase o pedidosRef no est√°n disponibles");
            mostrarGraficaEspecialSinDatos("Firebase no inicializado");
            return;
        }

        // Obtener todos los pedidos
        pedidosRef.once('value')
            .then((snapshot) => {
                if (!snapshot.exists()) {
                    mostrarGraficaEspecialSinDatos();
                    return;
                }

                snapshot.forEach((childSnapshot) => {
                    const pedido = childSnapshot.val();

                    // Verificar si el pedido es del d√≠a especial y coincide con la fecha
                    if (pedido.categoria === 'diaespecial' && pedido.estado !== 'Cancelado' && pedido.fechaFormateada === fechaFormateada) {
                        contadorPedidos++;

                        // Procesar productos del pedido
                        if (pedido.productos && Array.isArray(pedido.productos)) {
                            pedido.productos.forEach(producto => {
                                const nombreProducto = producto.nombre;
                                const cantidad = producto.cantidad || 1;
                                const precio = parseFloat(producto.precio || 0) * cantidad;

                                // Suma para estad√≠sticas generales
                                contadorProductosTotal += cantidad;
                                ingresoTotal += precio;

                                // Datos para gr√°fica de productos
                                if (!datosProductosEspecial[nombreProducto]) {
                                    datosProductosEspecial[nombreProducto] = cantidad;
                                } else {
                                    datosProductosEspecial[nombreProducto] += cantidad;
                                }

                                // Datos para gr√°fica de ingresos
                                if (!datosIngresosEspecial[nombreProducto]) {
                                    datosIngresosEspecial[nombreProducto] = precio;
                                } else {
                                    datosIngresosEspecial[nombreProducto] += precio;
                                }
                            });
                        }
                    }
                });

                // Actualizar estad√≠sticas
                document.getElementById('total-pedidos-especial').textContent = contadorPedidos;
                document.getElementById('total-productos-especial').textContent = contadorProductosTotal;
                document.getElementById('total-ingresos-especial').textContent = `$${ingresoTotal.toLocaleString()}`;

                // Crear o actualizar la gr√°fica
                actualizarGraficaEspecial();
            })
            .catch((error) => {
                console.error("Error al recopilar datos de ventas del d√≠a especial: ", error);
                mostrarGraficaEspecialSinDatos("Error: " + error.message);
            });
    }

    // Funci√≥n para actualizar la gr√°fica
    function actualizarGraficaEspecial() {
        // Verificar si Chart est√° disponible
        if (typeof Chart === 'undefined') {
            console.error("Chart.js no est√° disponible");
            mostrarGraficaEspecialSinDatos("Chart.js no disponible");
            return;
        }

        // Destruir gr√°fica existente si hay
        if (graficaEspecialChart) {
            graficaEspecialChart.destroy();
        }

        // Obtener datos seg√∫n el tipo de gr√°fica seleccionado
        const datos = tipoGraficaEspecialActual === 'productos' ? datosProductosEspecial : datosIngresosEspecial;

        // Verificar si hay datos
        if (Object.keys(datos).length === 0) {
            mostrarGraficaEspecialSinDatos();
            return;
        }

        // Ordenar datos para mostrar los m√°s vendidos primero
        const datosOrdenados = Object.entries(datos)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 8); // Mostrar solo los 8 principales

        const labels = datosOrdenados.map(item => item[0]);
        const values = datosOrdenados.map(item => item[1]);

        // Crear colores para las barras
        const backgroundColors = generarColoresDiaEspecial(labels.length);

        // Crear la gr√°fica
        const ctx = document.getElementById('grafica-especial-canvas').getContext('2d');
        graficaEspecialChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: tipoGraficaEspecialActual === 'productos' ? 'Cantidad vendida' : 'Ingresos ($)',
                    data: values,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors.map(color => color.replace('0.6', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (tipoGraficaEspecialActual === 'ingresos') {
                                    label += '$' + context.parsed.y.toLocaleString();
                                } else {
                                    label += context.parsed.y;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (tipoGraficaEspecialActual === 'ingresos') {
                                    return '$' + value;
                                }
                                return value;
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }

    // Funci√≥n para mostrar gr√°fica sin datos
    function mostrarGraficaEspecialSinDatos(mensaje = "No hay datos disponibles") {
        document.getElementById('total-pedidos-especial').textContent = '0';
        document.getElementById('total-productos-especial').textContent = '0';
        document.getElementById('total-ingresos-especial').textContent = '$0';

        // Destruir gr√°fica existente si hay
        if (graficaEspecialChart) {
            graficaEspecialChart.destroy();
        }

        // Verificar si Chart est√° disponible
        if (typeof Chart === 'undefined') {
            const canvas = document.getElementById('grafica-especial-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '14px Arial';
            ctx.fillText('Chart.js no est√° disponible', 10, 50);
            return;
        }

        // Crear gr√°fica vac√≠a con mensaje
        const ctx = document.getElementById('grafica-especial-canvas').getContext('2d');
        graficaEspecialChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [mensaje],
                datasets: [{
                    label: mensaje,
                    data: [0],
                    backgroundColor: ['rgba(200, 200, 200, 0.2)'],
                    borderColor: ['rgba(200, 200, 200, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1
                    }
                }
            }
        });
    }

    // Funci√≥n para generar colores (implementaci√≥n propia para evitar dependencias)
    function generarColoresDiaEspecial(cantidad) {
        const colores = [
            'rgba(255, 99, 132, 0.6)',  // Rojo
            'rgba(54, 162, 235, 0.6)',  // Azul
            'rgba(255, 206, 86, 0.6)',  // Amarillo
            'rgba(75, 192, 192, 0.6)',  // Verde azulado
            'rgba(153, 102, 255, 0.6)', // Morado
            'rgba(255, 159, 64, 0.6)',  // Naranja
            'rgba(199, 199, 199, 0.6)', // Gris
            'rgba(83, 102, 255, 0.6)'   // Azul violeta
        ];

        // Si necesitamos m√°s colores, repetimos los existentes
        const resultado = [];
        for (let i = 0; i < cantidad; i++) {
            resultado.push(colores[i % colores.length]);
        }

        return resultado;
    }
}

// Inicializar la funcionalidad cuando el DOM est√© completamente cargado
document.addEventListener('DOMContentLoaded', function() {
    // Verificar primero si Chart.js est√° cargado
    if (typeof Chart === 'undefined') {
        console.warn("Chart.js no est√° cargado. Intentando cargar Chart.js...");

        // Intentar cargar Chart.js din√°micamente
        const chartScript = document.createElement('script');
        chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        chartScript.onload = function() {
            console.log("Chart.js cargado correctamente.");
            // Iniciar la gr√°fica del d√≠a especial despu√©s de cargar Chart.js
            mostrarGraficaDiaEspecial();
        };
        chartScript.onerror = function() {
            console.error("No se pudo cargar Chart.js.");
            alert("Error: No se pudo cargar Chart.js para la gr√°fica del d√≠a especial.");
        };
        document.head.appendChild(chartScript);
    } else {
        // Chart.js ya est√° cargado, iniciar la gr√°fica directamente
        mostrarGraficaDiaEspecial();
    }
});

firebase.auth().onAuthStateChanged(user => {
    if (user) {
        const email = user.email; // Obtener el email del admin autenticado
        console.log("Email del usuario autenticado:", email);

        firebase.database().ref("admis").once("value")
            .then(snapshot => {
                const admins = snapshot.val();
                let nombreAdmin = "Nombre no encontrado";

                // Buscar el admin por su email
                for (let key in admins) {
                    if (admins[key].email === email) {
                        nombreAdmin = admins[key].nombre;
                        break;
                    }
                }

                document.getElementById("admin-name").textContent = nombreAdmin;
            })
            .catch(error => {
                console.error("Error al obtener el nombre:", error);
            });
    } else {
        console.log("No hay usuario autenticado");
    }
});




</script>

</body>
</html>